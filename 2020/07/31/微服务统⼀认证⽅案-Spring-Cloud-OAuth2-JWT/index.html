

<!DOCTYPE html>
<html lang="zh-CN" >



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="来啦，老弟，这里是 AKA 190">
  <meta name="author" content="190coder">
  <meta name="keywords" content="Java Php hexo Thinking in Java">
  <title>微服务统⼀认证⽅案 Spring Cloud OAuth2 + JWT - 190呐</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css">
  

  


<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">

<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 60vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>190coder</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-07-31 00:14" pubdate>
      2020年7月31日 凌晨
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      79
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">微服务统⼀认证⽅案 Spring Cloud OAuth2 + JWT</h1>
            
            <div class="markdown-body" id="post-body">
              <section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;"><h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">一、微服务架构下统⼀认证思路</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">基于Session的认证⽅式：在分布式的环境下，基于session的认证会出现⼀个问题，每个应⽤服务都需要在session中存储⽤
户身份信息，通过负载均衡将本地的请求分配到另⼀个应⽤服务需要将session信息带过去，否则会重新认证。我们可以使⽤Session共享、Session黏贴等⽅案。</p>
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: black;">Session⽅案也有缺点，⽐如基于cookie，移动端不能有效使⽤等</strong></p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">基于token的认证⽅式 ： 基于token的认证⽅式，服务端不⽤存储认证数据，易维护扩展性强， 客户端可以把token 存在任
意地⽅，并且可以实现web和app统⼀认证机制。其缺点也很明显，token由于⾃包含信息，因此⼀般数据量较⼤，⽽且每次请求 都需要传递，因此⽐较占带宽。另外，token的签名验签操作也会给cpu带来额外的处理负担。</p>
</section></li></ul>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">二、OAuth2开放授权协议/标准</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">1. OAuth2介绍</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">OAuth（开放授权）<strong style="font-weight: bold; color: black;">是⼀个开放协议/标准</strong>，允许⽤户授权第三⽅应⽤访问他们存储在另外的服务提供者上的信息，⽽不需要将⽤户名和密码提供给第三⽅应⽤或分享他们数据的所有内容。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: black;">OAuth2是OAuth协议的延续版本，但不向后兼容OAuth1即完全废⽌了OAuth1。</strong></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: black;">允许⽤户授权第三⽅应⽤访问他们存储在另外的服务提供者上的信息，⽽不需要将⽤户名和密码提供给第三⽅应⽤或分享他们数据的所有内容</strong></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">举例：所有的第三方登陆授权都算OAuth，不想注册在第三方网站，可以用QQ、微信授权登陆，开放部分功能。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">2. OAuth2协议⻆⾊和流程</span><span class="suffix" style="display: none;"></span></h3>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://imgkr.cn-bj.ufileos.com/bc928198-f8c5-40f3-8a33-b50e3ff2bfdf.png" srcset="/img/loading.gif" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">资源所有者（Resource Owner）：可以理解为⽤户⾃⼰</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">客户端（Client）：我们想登陆的⽹站或应⽤，⽐如拉勾⽹</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">认证服务器（Authorization Server）：可以理解为微信或者QQ</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">资源服务器（Resource Server）：可以理解为微信或者QQ</section></li></ul>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">3. 什么情况下需要使⽤OAuth2？</span><span class="suffix" style="display: none;"></span></h3>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">第三⽅授权登录的场景 ： 微信授权登录、QQ授权登录、微博授权登录等，这是典型的 OAuth2 使⽤场景。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">单点登录的场景 ：微服务场景，可以专⻔做⼀个认证中⼼（充当认证平台⻆⾊），所有的服务都要到这个认证中⼼做认证，只做⼀次登录，就可以在多个授权范围内的服务中⾃由串⾏。</section></li></ul>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">4. OAuth2的颁发Token授权⽅式</span><span class="suffix" style="display: none;"></span></h3>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">授权码（authorization-code）</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">密码式（password）提供⽤户名+密码换取token令牌</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">隐藏式（implicit）</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">客户端凭证（client credentials）</section></li></ol>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">授权码模式使⽤到了回调地址，是最复杂的授权⽅式，微博、微信、QQ等第三⽅登录就是这种模式。一般都是使用密码模式（提供⽤户名+密码换取token）。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">三、Spring Cloud OAuth2 + JWT 实现</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">1. Spring Cloud OAuth2介绍</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">Spring Cloud OAuth2 是 Spring Cloud 体系对OAuth2协议的实现，可以⽤来做多个微服务的统⼀认证（验证身份合法性）授权（验证权限）。通过向OAuth2服务（统⼀认证授权服务）发送某个类型的grant_type进⾏集中认证和授权，从⽽获得access_token（访问令牌），⽽这个token是受其他微服务信任的。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: black;">注意：使⽤OAuth2解决问题的本质是，引⼊了⼀个认证授权层，认证授权层连接了资源的拥有者，在授权层⾥⾯，资源的拥有者可以给第三⽅应⽤授权去访问我们的某些受保护资源。</strong></p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">2. Spring Cloud OAuth2构建微服务统⼀认证服务思路</span><span class="suffix" style="display: none;"></span></h3>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://imgkr.cn-bj.ufileos.com/077b2f96-786c-450f-aa90-abd459282659.png" srcset="/img/loading.gif" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">注意：如果比喻成第三方登陆，在我们统⼀认证的场景中，Resource Server其实就是我们的各种受保护的微服务，微服务中的各种API访问接⼝就是资源，发起http请求的浏览器就是Client客户端（对应为第三⽅应⽤），资源服务器就是从三方登陆（比如QQ）那里拿到的头像姓名等信息。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">3. （进入开发）搭建认证服务器（Authorization Server）和 资源服务器 （Resource Server）</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: black;">搭建 认证服务器（Authorization Server），负责颁发token</strong></p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">新建项⽬lagou-cloud-oauth-server-9999</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">引入依赖 pom.xml</p>
</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">&lt;!--导入Eureka Client依赖--&gt;</span>
<span>        <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">dependency</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>
<span>        <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">dependency</span>&gt;</span>
<span>
<span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">&lt;!--导入spring cloud oauth2依赖--&gt;</span>
<span>        <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">dependency</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">exclusions</span>&gt;</span>
<span>                <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">exclusion</span>&gt;</span>
<span>                    <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>org.springframework.security.oauth.boot<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>
<span>                    <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>spring-security-oauth2-autoconfigure<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>
<span>                <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">exclusion</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">exclusions</span>&gt;</span>
<span>        <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">dependency</span>&gt;</span>
<span>        <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">dependency</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>org.springframework.security.oauth.boot<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>spring-security-oauth2-autoconfigure<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">version</span>&gt;</span>2.1.11.RELEASE<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">version</span>&gt;</span>
<span>        <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">dependency</span>&gt;</span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">&lt;!--引入security对oauth2的支持--&gt;</span>
<span>        <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">dependency</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>org.springframework.security.oauth<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">groupId</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>spring-security-oauth2<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">artifactId</span>&gt;</span>
<span>            <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">version</span>&gt;</span>2.3.4.RELEASE<span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">version</span>&gt;</span>
<span>        <span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">dependency</span>&gt;</span>
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">application.yml（构建认证服务器，配置⽂件⽆特别之处）</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-attr" style="line-height: 26px;">server:</span>
<span><span class="hljs-attr" style="line-height: 26px;">  port:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">9999</span>
<span><span class="hljs-attr" style="line-height: 26px;">Spring:</span>
<span><span class="hljs-attr" style="line-height: 26px;">  application:</span>
<span><span class="hljs-attr" style="line-height: 26px;">    name:</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">lagou-cloud-oauth-server</span>
<span><span class="hljs-attr" style="line-height: 26px;">  datasource:</span>
<span><span class="hljs-attr" style="line-height: 26px;">    driver-class-name:</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">com.mysql.jdbc.Driver</span>
<span><span class="hljs-attr" style="line-height: 26px;">    url:</span> <span class="hljs-attr" style="line-height: 26px;">jdbc:mysql://localhost:3306/oauth2?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowMultiQueries=true</span>
<span><span class="hljs-attr" style="line-height: 26px;">    username:</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">root</span>
<span><span class="hljs-attr" style="line-height: 26px;">    password:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">123456</span>
<span><span class="hljs-attr" style="line-height: 26px;">    druid:</span>
<span><span class="hljs-attr" style="line-height: 26px;">      initialSize:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">10</span>
<span><span class="hljs-attr" style="line-height: 26px;">      minIdle:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">10</span>
<span><span class="hljs-attr" style="line-height: 26px;">      maxActive:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">30</span>
<span><span class="hljs-attr" style="line-height: 26px;">      maxWait:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">50000</span>
<span><span class="hljs-attr" style="line-height: 26px;">eureka:</span>
<span><span class="hljs-attr" style="line-height: 26px;">  client:</span>
<span><span class="hljs-attr" style="line-height: 26px;">    serviceUrl:</span> <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;"># eureka server的路径</span>
<span><span class="hljs-attr" style="line-height: 26px;">      defaultZone:</span> <span class="hljs-attr" style="line-height: 26px;">http://lagoucloudeurekaservera:8761/eureka/,http://lagoucloudeurekaserverb:8762/eureka/</span> <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">#把 eureka 集群中的所有 url 都填写了进来，也可以只写一台，因为各个 eureka server 可以同步注册表</span>
<span><span class="hljs-attr" style="line-height: 26px;">  instance:</span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">#使用ip注册，否则会使用主机名注册了（此处考虑到对老版本的兼容，新版本经过实验都是ip）</span>
<span><span class="hljs-attr" style="line-height: 26px;">    prefer-ip-address:</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">true</span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">#自定义实例显示格式，加上版本号，便于多版本管理，注意是ip-address，早期版本是ipAddress</span>
<span><span class="hljs-attr" style="line-height: 26px;">    instance-id:</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">${spring.cloud.client.ip-address}:${spring.application.name}:${server.port}:@project.version@</span>
<span>
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">⼊⼝类⽆特殊之处（@SpringBootApplication @EnableDiscoveryClient还是老二位）</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">认证服务器配置类</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">package</span> config;
<span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.beans.factory.annotation.Autowired;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.context.annotation.Configuration;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.http.HttpMethod;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.authentication.AuthenticationManager;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.provider.token.AuthorizationServerTokenServices;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.provider.token.TokenStore;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.provider.token.store.InMemoryTokenStore;
<span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@author</span>: 190coder &lt;190coder.cn&gt;
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@description</span>:  当前类为Oauth2 server的配置类（需要继承特定的⽗类)
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@create</span>: 2020-07-30 20:03
<span> */</span>
<span>
<span><span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Configuration</span>
<span><span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@EnableAuthorizationServer</span> <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 开启认证服务器功能</span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">OauthServerConfiger</span>  <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">extends</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">AuthorizationServerConfigurerAdapter</span> </span>{
<span>
<span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Autowired</span>
<span>    <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> AuthenticationManager authenticationManager;
<span>    
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 认证服务器最终是以api接⼝的⽅式对外提供服务（校验合法性并⽣成令牌、校验令牌等）
<span>     * 那么，以api接⼝⽅式对外的话，就涉及到接⼝的访问权限，我们需要在这⾥进⾏必要的配置
<span>     *
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@param</span> security
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@throws</span> Exception
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span> <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">configure</span><span class="hljs-params" style="line-height: 26px;">(AuthorizationServerSecurityConfigurer security)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.configure(security);
<span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 相当于打开endpoints 访问接⼝的开关，这样的话后期我们能够访问该接⼝</span>
<span>        security.
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 允许客户端表单认证</span>
<span>                allowFormAuthenticationForClients()
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 开启端⼝/oauth/token_key的访问权限（允许）</span>
<span>                .tokenKeyAccess(<span class="hljs-string" style="color: #d14; line-height: 26px;">"permitAll()"</span>)
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 开启端⼝/oauth/check_token的访问权限（允许）</span>
<span>                .checkTokenAccess(<span class="hljs-string" style="color: #d14; line-height: 26px;">"permitAll()"</span>);
<span>
<span>    }
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 客户端详情配置，
<span>     * ⽐如client_id，secret
<span>     * 当前这个服务就如同QQ平台，拉勾⽹作为客户端需要qq平台进⾏登录授权认证等，提前需
<span>       要到QQ平台注册，QQ平台会给拉勾⽹
<span>     * 颁发client_id等必要参数，表明客户端是谁
<span>     *
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@param</span> clients
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@throws</span> Exception
<span>     *
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span> <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">configure</span><span class="hljs-params" style="line-height: 26px;">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.configure(clients);
<span>
<span>        clients.
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 客户端信息存储在什么地⽅，可以在内存中，可以在数据库⾥</span>
<span>                inMemory()
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 添加⼀个client配置,指定其client_id</span>
<span>                .withClient(<span class="hljs-string" style="color: #d14; line-height: 26px;">"client_lagou"</span>)
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 指定客户端的密码/安全码</span>
<span>                .secret(<span class="hljs-string" style="color: #d14; line-height: 26px;">"abcxyz"</span>)
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 指定客户端所能访问资源</span>
<span>                .resourceIds(<span class="hljs-string" style="color: #d14; line-height: 26px;">"autodeliver"</span>)
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 认证类型/令牌颁发模式，可以配置多个在这⾥，但是不⼀定都⽤，具体使⽤哪种⽅式颁发token，需要客户端调⽤的时候传递参数指定</span>
<span>                .authorizedGrantTypes(<span class="hljs-string" style="color: #d14; line-height: 26px;">"password"</span>,<span class="hljs-string" style="color: #d14; line-height: 26px;">"refresh_token"</span>)
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 客户端的权限范围，此处配置为all全部即可</span>
<span>                .scopes(<span class="hljs-string" style="color: #d14; line-height: 26px;">"all"</span>);
<span>    }
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 认证服务器是玩转token的，那么这⾥配置token令牌管理相关（token此时就是⼀个字符
<span>        串，当下的token需要在服务器端存储，那么存储在哪⾥呢？都是在这⾥配置）
<span>     *
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@param</span> endpoints
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@throws</span> Exception
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span> <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">configure</span><span class="hljs-params" style="line-height: 26px;">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.configure(endpoints);
<span>
<span>        endpoints
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 指定token的存储⽅法</span>
<span>                .tokenStore(tokenStore())
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//token服务的⼀个描述，可以认为是token⽣成细节的描述，⽐如有效时间多少等</span>
<span>                .tokenServices(authorizationServerTokenServices())
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 指定认证管 理器，随后注⼊⼀个到当前类使⽤即可</span>
<span>                .authenticationManager(authenticationManager)
<span>                .allowedTokenEndpointRequestMethods(HttpMethod.GET,HttpMethod.POST);
<span>    }
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 该⽅法⽤户获取⼀个token服务对象（该对象描述了token有效期等信息）
<span>     *
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@return</span>
<span>     */</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> AuthorizationServerTokenServices <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">authorizationServerTokenServices</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{
<span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 使⽤默认实现</span>
<span>        DefaultTokenServices defaultTokenServices = <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> DefaultTokenServices();
<span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 是否开启令牌刷新</span>
<span>        defaultTokenServices.setSupportRefreshToken(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">true</span>);
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// token以什么形式存储</span>
<span>        defaultTokenServices.setTokenStore(tokenStore());
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// access_token就是我们请求资源需要携带的令牌</span>
<span>        defaultTokenServices.setAccessTokenValiditySeconds(<span class="hljs-number" style="color: #008080; line-height: 26px;">30</span>);
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 设置刷新令牌的有效时间 3天</span>
<span>        defaultTokenServices.setRefreshTokenValiditySeconds(<span class="hljs-number" style="color: #008080; line-height: 26px;">259200</span>);
<span>
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> defaultTokenServices;
<span>
<span>    }
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 该⽅法⽤于创建tokenStore对象（令牌存储对象）token以什么形式存储
<span>    */</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> TokenStore <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">tokenStore</span><span class="hljs-params" style="line-height: 26px;">()</span></span>{
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> InMemoryTokenStore();
<span>    }
<span>}
<span>
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<blockquote data-tool="mdnice编辑器" style="display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px; border-left-color: rgb(239, 112, 96); background: #fff9f9;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">配置类解读：</p>
</blockquote>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">关于三个configure⽅法</p>
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">configure(ClientDetailsServiceConfigurer clients) : 客户端详情信息在 这⾥进⾏初始化，你能够把客户端详情信息写死在这⾥或者是通过数据库来存储调取详情信息</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">configure(AuthorizationServerEndpointsConfigurer endpoints) : 配置令牌（token）的访问端点和令牌服务(token services) 和存储介质</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">configure(AuthorizationServerSecurityConfigurer oauthServer) ： 配置访问权限和令牌服务(token services)</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">关于 TokenStore</p>
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">InMemoryTokenStore ：<strong style="font-weight: bold; color: black;">存放内存中。</strong> 默认采⽤，它可以完美的⼯作在单服务器上（即访问并发量 压⼒不⼤的情况下，并且它在失败的时候不会进⾏备份），⼤多数的项⽬都可以使⽤这个版本的实现来进⾏ 尝试，你可以在开发的时候使⽤它来进⾏管理，因为不会被保存到磁盘中，所以更易于调试。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">JdbcTokenStore ： 这是⼀个基于JDBC的实现版本，令牌会被<strong style="font-weight: bold; color: black;">保存进关系型数据库</strong>。使⽤这个版本的实现时， 你可以在不同的服务器之间共享令牌信息，使⽤这个版本的时候请注意把"springjdbc"这个依赖加⼊到你的 classpath当中。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">JwtTokenStore ： 全称是 JSON Web Token（JWT），它可以把令牌相关的数据进⾏编码（因此对于后端服务来说，<strong style="font-weight: bold; color: black;">它不需要进⾏存储</strong>，这将是⼀个重⼤优势），缺点就是这个令牌占⽤的空间会⽐较⼤，如果你加⼊了⽐较多⽤户凭证信息，JwtTokenStore 不会保存任何数据。</section></li></ul>
</section></li></ul>
<blockquote data-tool="mdnice编辑器" style="display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px; border-left-color: rgb(239, 112, 96); background: #fff9f9;"></blockquote>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">认证服务器安全配置类</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">package</span> config;
<span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.beans.factory.annotation.Autowired;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.context.annotation.Bean;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.context.annotation.Configuration;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.authentication.AuthenticationManager;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.core.userdetails.User;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.core.userdetails.UserDetails;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.crypto.password.NoOpPasswordEncoder;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.crypto.password.PasswordEncoder;
<span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> java.util.ArrayList;
<span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@author</span>: 190coder &lt;190coder.cn&gt;
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@description</span>: 该配置类，主要处理⽤户名和密码的校验等事宜
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@create</span>: 2020-07-30 20:52
<span> */</span>
<span>
<span><span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Configuration</span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">SecurityConfiger</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">extends</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">WebSecurityConfigurerAdapter</span> </span>{
<span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Autowired</span>
<span>    <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> PasswordEncoder passwordEncoder;
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 注册⼀个认证管理器对象到容器
<span>     *
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@throws</span> Exception
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Bean</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> AuthenticationManager <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">authenticationManagerBean</span><span class="hljs-params" style="line-height: 26px;">()</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.authenticationManagerBean();
<span>    }
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 
<span>     * 处理⽤户名和密码验证事宜
<span>     * 1）客户端传递username和password参数到认证服务器
<span>     * 2）⼀般来说，username和password会存储在数据库中的⽤户表中
<span>     * 3）根据⽤户表中数据，验证当前传递过来的⽤户信息的合法性
<span>     *
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span> <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">configure</span><span class="hljs-params" style="line-height: 26px;">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 在这个⽅法中就可以去关联数据库了，当前我们先把⽤户信息配置在内存中</span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 实例化⼀个⽤户对象(相当于数据表中的⼀条⽤户记录)</span>
<span>        UserDetails user = <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> User(<span class="hljs-string" style="color: #d14; line-height: 26px;">"admin"</span>,<span class="hljs-string" style="color: #d14; line-height: 26px;">"123456"</span>,<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> ArrayList&lt;&gt;());
<span>        auth.inMemoryAuthentication()
<span>                .withUser(user).passwordEncoder(passwordEncoder);
<span>    }
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 密码编码对象（密码不进⾏加密处理）
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@return</span>
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Bean</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> PasswordEncoder <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">passwordEncoder</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> NoOpPasswordEncoder.getInstance();
<span>    }
<span>}
<span>
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">测试：启动Eureka Server 注册中心，和认证服务</section></li></ul>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">访问：http://localhost:9998/oauth/token?client_secret=abcxyz&amp;grant_type=password&amp;username=admin&amp;password=123456&amp;client_id=client_lagou</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">endpoint：/oauth/token</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">获取token携带的参数</p>
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">client_id：客户端id</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">client_secret：客户单密码</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">grant_type：指定使⽤哪种颁发类型，password</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">username：⽤户名</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">password：密码</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">校验token：http://localhost:9998/oauth/check_token?token=1068b57c-0b2d-4789-8ce5-fa968c402d0a</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">刷新 token ： http://localhost:9998/oauth/token?grant_type=refresh_token&amp;client_id=client_lagou&amp;client_secret=abcxyz&amp;refresh_token=7c47f959-17a6-4a09-8e7b-0f49bfaef725</p>
</section></li></ul>
<hr data-tool="mdnice编辑器" style="height: 1px; margin: 0; margin-top: 10px; margin-bottom: 10px; border: none; border-top: 1px solid black;">
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: black;">搭建 资源服务器（希望访问被认证的微服务）Resource Server配置</strong></p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">引入outh2对应jar包</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">资源服务配置类</p>
</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">package</span> com.lagou.edu.config;
<span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.context.annotation.Configuration;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.config.http.SessionCreationPolicy;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">import</span> org.springframework.security.oauth2.provider.token.RemoteTokenServices;
<span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@author</span>: 190coder &lt;190coder.cn&gt;
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@description</span>: 资源服务配置类
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@create</span>: 2020-07-30 21:20
<span> */</span>
<span>
<span><span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Configuration</span>
<span><span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@EnableResourceServer</span> <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 开启资源服务器功能</span>
<span><span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@EnableWebSecurity</span> <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 开启web访问安全</span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">ResourceServerConfiger</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">extends</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">ResourceServerConfigurerAdapter</span> </span>{
<span>
<span>    <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> String sign_key = <span class="hljs-string" style="color: #d14; line-height: 26px;">"190coder.cn"</span>; <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// jwt签名密钥</span>
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 该⽅法⽤于定义资源服务器向远程认证服务器发起请求，进⾏token校验等事宜
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@param</span> resources
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@throws</span> Exception
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span> <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">configure</span><span class="hljs-params" style="line-height: 26px;">(ResourceServerSecurityConfigurer resources)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span>        resources.resourceId(<span class="hljs-string" style="color: #d14; line-height: 26px;">"autodeliver"</span>);
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 定义token服务对象（token校验就应该靠token服务对象）</span>
<span>        RemoteTokenServices remoteTokenServices = <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> RemoteTokenServices();
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 校验端点/接⼝设置</span>
<span>        remoteTokenServices.setCheckTokenEndpointUrl(<span class="hljs-string" style="color: #d14; line-height: 26px;">"http://localhost:9998/oauth/check_token"</span>);
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 携带客户端id和客户端安全码</span>
<span>        remoteTokenServices.setClientId(<span class="hljs-string" style="color: #d14; line-height: 26px;">"client_lagou"</span>);
<span>        remoteTokenServices.setClientSecret(<span class="hljs-string" style="color: #d14; line-height: 26px;">"abcxyz"</span>);
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 别忘了这⼀步</span>
<span>        resources.tokenServices(remoteTokenServices);
<span>
<span>    }
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 场景：⼀个服务中可能有很多资源（API接⼝）
<span>     * 某⼀些API接⼝，需要先认证，才能访问
<span>     * 某⼀些API接⼝，压根就不需要认证，本来就是对外开放的接⼝
<span>     * 我们就需要对不同特点的接⼝区分对待（在当前configure⽅法中完成），设置
<span>     是否需要经过认证
<span>     *
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@param</span> http
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@throws</span> Exception
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span> <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">configure</span><span class="hljs-params" style="line-height: 26px;">(HttpSecurity http)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span>        http
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 设置session的创建策略（根据需要创建即可）</span>
<span>                .sessionManagement()
<span>                .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
<span>                .and()
<span>                .authorizeRequests()
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// autodeliver为前缀的请求需要认证</span>
<span>                .antMatchers(<span class="hljs-string" style="color: #d14; line-height: 26px;">"/autodeliver/**"</span>).authenticated()
<span>                <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// demo为前缀的请求需要认证</span>
<span>                .antMatchers(<span class="hljs-string" style="color: #d14; line-height: 26px;">"/demo/**"</span>).authenticated()
<span>                .anyRequest().permitAll(); <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 其他请求不认证</span>
<span>    }
<span>}
<span>
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<blockquote data-tool="mdnice编辑器" style="display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px; border-left-color: rgb(239, 112, 96); background: #fff9f9;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">思考：当我们第⼀次登陆之后，认证服务器颁发token并将其存储在认证服务器中，后期我们
访问资源服务器时会携带token，资源服务器会请求认证服务器验证token有效性，如果资源
服务器有很多，那么认证服务器压⼒会很⼤.......</p>
</blockquote>
<blockquote data-tool="mdnice编辑器" style="display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px; border-left-color: rgb(239, 112, 96); background: #fff9f9;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">另外，资源服务器向认证服务器check_token，获取的也是⽤户信息UserInfo，能否把⽤户信息存储到令牌中，让客户端⼀直持有这个令牌，令牌的验证也在资源服务器进⾏，这样避免和认证服务器频繁的交互......</p>
</blockquote>
<blockquote data-tool="mdnice编辑器" style="display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px; border-left-color: rgb(239, 112, 96); background: #fff9f9;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">我们可以考虑使⽤ JWT 进⾏改造，使⽤JWT机制之后资源服务器不需要访问认证服务器......</p>
</blockquote>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">5. JWT改造统⼀认证授权中⼼的令牌存储机制</span><span class="suffix" style="display: none;"></span></h3>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">5.1 JWT令牌介绍：</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">通过上边的测试我们发现，当资源服务和授权服务不在⼀起时资源服务使⽤RemoteTokenServices 远程请求授权 服务验证token，如果访问量较⼤将会影响系统的性能。
解决上边问题： 令牌采⽤JWT格式即可解决上边的问题，⽤户认证通过会得到⼀个JWT令牌，JWT令牌中已经包括了⽤户相关的信 息，客户端只需要携带JWT访问资源服务，资源服务根据事先约定的算法⾃⾏完成令牌校验，⽆需每次都请求认证 服务完成授权。</p>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">5.2 什么是JWT？</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">JSON Web Token（JWT）是⼀个开放的⾏业标准（RFC 7519），它定义了⼀种简介的、⾃包含的协议格式，⽤于 在通信双⽅传递json对象，传递的信息经过数字签名可以被验证和信任。<strong style="font-weight: bold; color: black;">JWT可以使⽤HMAC算法或使⽤RSA的公钥/私钥对来签名，防⽌被篡改</strong>。</p>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">5.3 JWT令牌结构</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">JWT令牌由三部分组成，每部分中间使⽤点（.）分隔，⽐如：xxxxx.yyyyy.zzzzz</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">Header ： 头部包括令牌的类型（即JWT）及使⽤的哈希算法（如HMAC SHA256或RSA），例如</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">{
<span><span class="hljs-attr" style="line-height: 26px;">"alg"</span>: <span class="hljs-string" style="color: #d14; line-height: 26px;">"HS256"</span>,
<span><span class="hljs-attr" style="line-height: 26px;">"typ"</span>: <span class="hljs-string" style="color: #d14; line-height: 26px;">"JWT"</span>
<span>}
<span></span></span></span></span></code></pre></div>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">将上边的内容使⽤Base64Url编码，得到⼀个字符串就是JWT令牌的第⼀部分。</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">Payload
第⼆部分是负载，内容也是⼀个json对象，它是存放有效信息的地⽅，它可以存放jwt提供的现成字段，⽐ 如：iss（签发者）,exp（过期时间戳）, sub（⾯向的⽤户）等，也可⾃定义字段。 此部分不建议存放敏感信息，因为此部分可以解码还原原始内容。 最后将第⼆部分负载使⽤Base64Url编码，得到⼀个字符串就是JWT令牌的第⼆部分。 ⼀个例⼦：</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">{
<span><span class="hljs-attr" style="line-height: 26px;">"sub"</span>: <span class="hljs-string" style="color: #d14; line-height: 26px;">"1234567890"</span>,
<span><span class="hljs-attr" style="line-height: 26px;">"name"</span>: <span class="hljs-string" style="color: #d14; line-height: 26px;">"John Doe"</span>,
<span><span class="hljs-attr" style="line-height: 26px;">"iat"</span>: <span class="hljs-number" style="color: #008080; line-height: 26px;">1516239022</span>
<span>}
<span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">Signature
第三部分是签名，此部分⽤于防⽌jwt内容被篡改。 这个部分使⽤base64url将前两部分进⾏编码，编码后使⽤点（.）连接组成字符串，最后使⽤header中声明 签名算法进⾏签名。</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">HMACSHA<span class="hljs-number" style="color: #008080; line-height: 26px;">2</span><span class="hljs-number" style="color: #008080; line-height: 26px;">5</span><span class="hljs-number" style="color: #008080; line-height: 26px;">6</span>(
<span>  base<span class="hljs-number" style="color: #008080; line-height: 26px;">6</span><span class="hljs-number" style="color: #008080; line-height: 26px;">4</span>UrlEncode(header) + <span class="hljs-string" style="color: #d14; line-height: 26px;">"."</span> +
<span>  base<span class="hljs-number" style="color: #008080; line-height: 26px;">6</span><span class="hljs-number" style="color: #008080; line-height: 26px;">4</span>UrlEncode(payload),
<span>  secret)
<span></span></span></span></span></code></pre></div>
<div class="hljs"><pre><code style="display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">- base64UrlEncode(header)：jwt令牌的第⼀部分。
- base64UrlEncode(payload)：jwt令牌的第⼆部分。
- secret：签名所使⽤的密钥。
</code></pre></div>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">5.4 代码改造 （认证服务器 和 资源服务器）</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: black;">认证服务器端JWT改造(改造主配置类)</strong></p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">改造存token的介质，改为jwt，再配置转换器，将信息转化jwt token</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 该⽅法⽤于创建tokenStore对象（令牌存储对象）token以什么形式存储
<span>    */</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> TokenStore <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">tokenStore</span><span class="hljs-params" style="line-height: 26px;">()</span></span>{
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//return new InMemoryTokenStore();</span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 使⽤jwt令牌</span>
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> JwtTokenStore(jwtAccessTokenConverter());
<span>    }
<span>
<span>    <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> String sign_key = <span class="hljs-string" style="color: #d14; line-height: 26px;">"xxxxx"</span>; <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// jwt签名密钥</span>
<span>    
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 返回jwt令牌转换器（帮助我们⽣成jwt令牌的）
<span>     * 在这⾥，我们可以把签名密钥传递进去给转换器对象
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@return</span>
<span>     */</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> JwtAccessTokenConverter <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">jwtAccessTokenConverter</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{
<span>
<span>        JwtAccessTokenConverter jwtAccessTokenConverter = <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> JwtAccessTokenConverter();
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 签名密钥</span>
<span>        jwtAccessTokenConverter.setSigningKey(sign_key);
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 验证时使⽤的密钥，和签名密钥保持⼀致</span>
<span>        jwtAccessTokenConverter.setVerifier(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> MacSigner(sign_key));
<span>
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> jwtAccessTokenConverter;
<span>    }
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">修改 JWT 令牌服务⽅法，主要是添加jwt 转换器</section></li></ul>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://imgkr.cn-bj.ufileos.com/e0e283f4-bfc3-4798-8c57-df7a8063ef34.png" srcset="/img/loading.gif" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: black;">资源服务器校验JWT令牌</strong></p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">不需要和远程认证服务器交互，添加本地tokenStore，修改configure 方法</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 该⽅法⽤于定义资源服务器向远程认证服务器发起请求，进⾏token校验等事宜
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@param</span> resources
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@throws</span> Exception
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span> <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">configure</span><span class="hljs-params" style="line-height: 26px;">(ResourceServerSecurityConfigurer resources)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        resources.resourceId("autodeliver");</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        // 定义token服务对象（token校验就应该靠token服务对象）</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        RemoteTokenServices remoteTokenServices = new RemoteTokenServices();</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        // 校验端点/接⼝设置</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        remoteTokenServices.setCheckTokenEndpointUrl("http://localhost:9998/oauth/check_token");</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        // 携带客户端id和客户端安全码</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        remoteTokenServices.setClientId("client_lagou");</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        remoteTokenServices.setClientSecret("abcxyz");</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        // 别忘了这⼀步</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        resources.tokenServices(remoteTokenServices);</span>
<span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// JWT 令牌改造</span>
<span>        resources.resourceId(<span class="hljs-string" style="color: #d14; line-height: 26px;">"autodeliver"</span>).tokenStore(tokenStore()).stateless(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">true</span>);
<span>
<span>    }
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">添加 和认证服务器一样的就问他token 存储</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">     <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 该⽅法⽤于创建tokenStore对象（令牌存储对象）token以什么形式存储
<span>     */</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> TokenStore <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">tokenStore</span><span class="hljs-params" style="line-height: 26px;">()</span></span>{
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//return new InMemoryTokenStore();</span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 使⽤jwt令牌</span>
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> JwtTokenStore(jwtAccessTokenConverter());
<span>    }
<span>
<span>    <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> String sign_key = <span class="hljs-string" style="color: #d14; line-height: 26px;">"190coder.cn"</span>; <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// jwt签名密钥</span>
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 返回jwt令牌转换器（帮助我们⽣成jwt令牌的）
<span>     * 在这⾥，我们可以把签名密钥传递进去给转换器对象
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@return</span>
<span>     */</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> JwtAccessTokenConverter <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">jwtAccessTokenConverter</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{
<span>
<span>        JwtAccessTokenConverter jwtAccessTokenConverter = <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> JwtAccessTokenConverter();
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 签名密钥</span>
<span>        jwtAccessTokenConverter.setSigningKey(sign_key);
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 验证时使⽤的密钥，和签名密钥保持⼀致</span>
<span>        jwtAccessTokenConverter.setVerifier(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> MacSigner(sign_key));
<span>
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> jwtAccessTokenConverter;
<span>    }
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">6. 从数据库加载Oauth2客户端信息</span><span class="suffix" style="display: none;"></span></h3>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">创建数据表并初始化。 数据根据源码可得出 （表名及字段保持固定）</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">SET</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">NAMES</span> utf8mb4;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">SET</span> FOREIGN_KEY_CHECKS = <span class="hljs-number" style="color: #008080; line-height: 26px;">0</span>;
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- ----------------------------</span>
<span>配置数据源
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- Table structure for oauth_client_details</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- ----------------------------</span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DROP</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">TABLE</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">IF</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">EXISTS</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">`oauth_client_details`</span>;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">CREATE</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">TABLE</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">`oauth_client_details`</span> (
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`client_id`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">varchar</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">48</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">NOT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`resource_ids`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">varchar</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">256</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`client_secret`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">varchar</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">256</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`scope`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">varchar</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">256</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`authorized_grant_types`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">varchar</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">256</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`web_server_redirect_uri`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">varchar</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">256</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`authorities`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">varchar</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">256</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`access_token_validity`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">int</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">11</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`refresh_token_validity`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">int</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">11</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`additional_information`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">varchar</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">4096</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`autoapprove`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">varchar</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">256</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span>PRIMARY <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">KEY</span> (<span class="hljs-string" style="color: #d14; line-height: 26px;">`client_id`</span>)
<span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">ENGINE</span>=<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">InnoDB</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">CHARSET</span>=utf8;
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- ----------------------------</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- Records of oauth_client_details</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- ----------------------------</span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">BEGIN</span>;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">INSERT</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">INTO</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">`oauth_client_details`</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">VALUES</span> (<span class="hljs-string" style="color: #d14; line-height: 26px;">'client_lagou123'</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">'autodeliver,resume'</span>, <span class="hljs-string" style="color: #d14; line-height: 26px;">'abcxyz'</span>, <span class="hljs-string" style="color: #d14; line-height: 26px;">'all'</span>, <span class="hljs-string" style="color: #d14; line-height: 26px;">'password,refresh_token'</span>, <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>, <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-number" style="color: #008080; line-height: 26px;">7200</span>, <span class="hljs-number" style="color: #008080; line-height: 26px;">259200</span>, <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>, <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>);
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">COMMIT</span>;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">SET</span> FOREIGN_KEY_CHECKS = <span class="hljs-number" style="color: #008080; line-height: 26px;">1</span>;
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">配置数据源</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-attr" style="line-height: 26px;">Spring:</span>
<span><span class="hljs-attr" style="line-height: 26px;">  application:</span>
<span><span class="hljs-attr" style="line-height: 26px;">    name:</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">test-oauth2-9998</span>
<span><span class="hljs-attr" style="line-height: 26px;">  datasource:</span>
<span><span class="hljs-attr" style="line-height: 26px;">    driver-class-name:</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">com.mysql.jdbc.Driver</span>
<span><span class="hljs-attr" style="line-height: 26px;">    url:</span> <span class="hljs-attr" style="line-height: 26px;">jdbc:mysql://localhost:3306/lagou_homework?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowMultiQueries=true</span>
<span><span class="hljs-attr" style="line-height: 26px;">    username:</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">root</span>
<span><span class="hljs-attr" style="line-height: 26px;">    password:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">123321</span>
<span><span class="hljs-attr" style="line-height: 26px;">    druid:</span>
<span><span class="hljs-attr" style="line-height: 26px;">      initialSize:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">10</span>
<span><span class="hljs-attr" style="line-height: 26px;">      minIdle:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">10</span>
<span><span class="hljs-attr" style="line-height: 26px;">      maxActive:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">30</span>
<span><span class="hljs-attr" style="line-height: 26px;">      maxWait:</span> <span class="hljs-number" style="color: #008080; line-height: 26px;">50000</span>
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">认证服务器主配置类改造</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 客户端详情配置，
<span>     * ⽐如client_id，secret
<span>     * 当前这个服务就如同QQ平台，拉勾⽹作为客户端需要qq平台进⾏登录授权认证等，提前需
<span>       要到QQ平台注册，QQ平台会给拉勾⽹
<span>     * 颁发client_id等必要参数，表明客户端是谁
<span>     *
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@param</span> clients
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@throws</span> Exception
<span>     *
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span> <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">configure</span><span class="hljs-params" style="line-height: 26px;">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.configure(clients);
<span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        clients.</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                // 客户端信息存储在什么地⽅，可以在内存中，可以在数据库⾥</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                inMemory()</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                // 添加⼀个client配置,指定其client_id</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                .withClient("client_lagou")</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                // 指定客户端的密码/安全码</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                .secret("abcxyz")</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                // 指定客户端所能访问资源</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                .resourceIds("autodeliver")</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                // 认证类型/令牌颁发模式，可以配置多个在这⾥，但是不⼀定都⽤，具体使⽤哪种⽅式颁发token，需要客户端调⽤的时候传递参数指定</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                .authorizedGrantTypes("password","refresh_token")</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                // 客户端的权限范围，此处配置为all全部即可</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                .scopes("all");</span>
<span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 从内存中加载客户端详情改为从数据库中加载客户端详情</span>
<span>        clients.withClientDetails(createJdbcClientDetailsService());
<span>    }
<span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Autowired</span>
<span>    <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> DataSource dataSource;
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Bean</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> JdbcClientDetailsService <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">createJdbcClientDetailsService</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{
<span>        JdbcClientDetailsService jdbcClientDetailsService = <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span>
<span>                JdbcClientDetailsService(dataSource);
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> jdbcClientDetailsService;
<span>    }
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">7. 从数据库验证⽤户合法性</span><span class="suffix" style="display: none;"></span></h3>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">创建数据表users（表名不需固定），初始化数据</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">SET</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">NAMES</span> utf8mb4;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">SET</span> FOREIGN_KEY_CHECKS = <span class="hljs-number" style="color: #008080; line-height: 26px;">0</span>;
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- ----------------------------</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- Table structure for users</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- ----------------------------</span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DROP</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">TABLE</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">IF</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">EXISTS</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">`users`</span>;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">CREATE</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">TABLE</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">`users`</span> (
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`id`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">int</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">11</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">NOT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span> AUTO_INCREMENT,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`username`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">char</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">10</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span><span class="hljs-string" style="color: #d14; line-height: 26px;">`password`</span> <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">char</span>(<span class="hljs-number" style="color: #008080; line-height: 26px;">100</span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-literal" style="color: #008080; line-height: 26px;">NULL</span>,
<span>PRIMARY <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">KEY</span> (<span class="hljs-string" style="color: #d14; line-height: 26px;">`id`</span>)
<span>) <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">ENGINE</span>=<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number" style="color: #008080; line-height: 26px;">5</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">DEFAULT</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">CHARSET</span>=utf8;
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- ----------------------------</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- Records of users</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">-- ----------------------------</span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">BEGIN</span>;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">INSERT</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">INTO</span> <span class="hljs-string" style="color: #d14; line-height: 26px;">`users`</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">VALUES</span> (<span class="hljs-number" style="color: #008080; line-height: 26px;">4</span>, <span class="hljs-string" style="color: #d14; line-height: 26px;">'lagou-user'</span>, <span class="hljs-string" style="color: #d14; line-height: 26px;">'iuxyzds'</span>);
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">COMMIT</span>;
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">SET</span> FOREIGN_KEY_CHECKS = <span class="hljs-number" style="color: #008080; line-height: 26px;">1</span>;
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">开发UserDetailsService接⼝的实现类，根据⽤户名从数据库加载⽤户信息</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@author</span>: 190coder &lt;190coder.cn&gt;
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@description</span>:  UserDetailsService接⼝的实现类
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@create</span>: 2020-07-30 23:19
<span> */</span>
<span><span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Service</span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">JdbcUserDetailsService</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">implements</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">UserDetailsService</span> </span>{
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// Jpa 查询</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Autowired</span>
<span>    <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> UsersRepository usersRepository;
<span>
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 根据username查询出该⽤户的所有信息，封装成UserDetails类型的对象返回，⾄于密码，框
<span>     * 架会⾃动匹配
<span>     *
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@param</span> s
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@return</span>
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@throws</span> UsernameNotFoundException
<span>     */</span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> UserDetails <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">loadUserByUsername</span><span class="hljs-params" style="line-height: 26px;">(String s)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> UsernameNotFoundException </span>{
<span>        Users users = usersRepository.findByUsername(s);
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> User(users.getUsername(),users.getPassword(),<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span>
<span>                ArrayList&lt;&gt;());
<span>    }
<span>}
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">使⽤⾃定义的⽤户详情服务对象 (验证配置类)</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Autowired</span>
<span>    <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">private</span> JdbcUserDetailsService jdbcUserDetailsService;
<span>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     *
<span>     * 处理⽤户名和密码验证事宜
<span>     * 1）客户端传递username和password参数到认证服务器
<span>     * 2）⼀般来说，username和password会存储在数据库中的⽤户表中
<span>     * 3）根据⽤户表中数据，验证当前传递过来的⽤户信息的合法性
<span>     *
<span>     */</span>
<span>    
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span> <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">configure</span><span class="hljs-params" style="line-height: 26px;">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">throws</span> Exception </span>{
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 在这个⽅法中就可以去关联数据库了，当前我们先把⽤户信息配置在内存中</span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 实例化⼀个⽤户对象(相当于数据表中的⼀条⽤户记录)</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        UserDetails user = new User("admin","123456",new ArrayList&lt;&gt;());</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//        auth.inMemoryAuthentication()</span>
<span><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//                .withUser(user).passwordEncoder(passwordEncoder);</span>
<span>
<span>        auth.userDetailsService(jdbcUserDetailsService).passwordEncoder(passwordEncoder);
<span>    }
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">8. 基于Oauth2的 JWT 令牌信息扩展</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">OAuth2帮我们⽣成的JWT令牌载荷部分信息有限，关于⽤户信息只有⼀个user_name，有些场景下我们希望放⼊⼀些扩展信息项，比如IP （提高安全性） ，UserId...,如下添加扩展信息：</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: black;">认证服务器⽣成JWT令牌时存⼊扩展信息（⽐如clientIp）</strong></p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">继承DefaultAccessTokenConverter类，重写convertAccessToken⽅法存⼊扩展信息</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@author</span>: 190coder &lt;190coder.cn&gt;
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@description</span>: 自定义扩展信息
<span> * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@create</span>: 2020-07-30 23:41
<span> */</span>
<span><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">LagouAccessTokenConvertor</span> <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">extends</span> <span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">DefaultAccessTokenConverter</span> </span>{
<span>
<span>    <span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span>
<span>    <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> Map&lt;String, ?&gt; convertAccessToken(OAuth2AccessToken token, OAuth2Authentication authentication) {
<span>
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 获取到request对象</span>
<span>        HttpServletRequest request = ((ServletRequestAttributes)
<span>                (RequestContextHolder.getRequestAttributes())).getRequest();
<span>        <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 获取客户端ip（注意：如果是经过代理之后到达当前服务的话，那么这种⽅式获取的并不是真实的浏览器客户端ip）</span>
<span>        String remoteAddr = request.getRemoteAddr();
<span>        Map&lt;String, String&gt; stringMap = (Map&lt;String, String&gt;)
<span>                <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.convertAccessToken(token, authentication);
<span>        stringMap.put(<span class="hljs-string" style="color: #d14; line-height: 26px;">"clientIp"</span>,remoteAddr);
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> stringMap;
<span>    }
<span>}
<span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">将⾃定义的转换器对象注⼊到配置jwt返回的类中</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"> <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">/**
<span>     * 返回jwt令牌转换器（帮助我们生成jwt令牌的）
<span>     * 在这里，我们可以把签名密钥传递进去给转换器对象
<span>     * <span class="hljs-doctag" style="color: #d14; line-height: 26px;">@return</span>
<span>     */</span>
<span>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span> JwtAccessTokenConverter <span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">jwtAccessTokenConverter</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{
<span>        JwtAccessTokenConverter jwtAccessTokenConverter = <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> JwtAccessTokenConverter();
<span>        jwtAccessTokenConverter.setSigningKey(sign_key);  <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 签名密钥</span>
<span>        jwtAccessTokenConverter.setVerifier(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span> MacSigner(sign_key));  <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 验证时使用的密钥，和签名密钥保持一致</span>
<span>        jwtAccessTokenConverter.setAccessTokenConverter(lagouAccessTokenConvertor);
<span>        <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span> jwtAccessTokenConverter;
<span>    }
<span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre></div>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">9. 资源服务器取出 JWT 令牌扩展信息</span><span class="suffix" style="display: none;"></span></h3>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">资源服务器也需要⾃定义⼀个转换器类，继承DefaultAccessTokenConverter，重写
extractAuthentication提取⽅法，把载荷信息设置到认证对象的details属性中</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">将⾃定义的转换器对象注⼊ （返回jwt令牌转换器）的方法</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">业务类⽐如Controller类中，可以通过SecurityContextHolder.getContext().getAuthentication()获取到认证对象，进⼀步获取到扩展信息</p>
</section></li></ul>
<div class="hljs"><pre class="hljs custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">Object details = SecurityContextHolder.getContext().getAuthentication().getDetails();
<span></span></code></pre></div>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">获取到扩展信息后，就可以做其他的处理了，⽐如根据userId进⼀步处理，或者根据clientIp处理，或者其他都是可以的了</section></li></ul>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">10. 注意事项</span><span class="suffix" style="display: none;"></span></h3>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">JWT令牌就是⼀种可以被验证的数据组织格式，它的玩法很灵活，我们这⾥是基于Spring Cloud Oauth2 创建、校验JWT令牌</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">我们也可以⾃⼰写⼯具类⽣成、校验JWT令牌</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">JWT令牌中不要存放过于敏感的信息，因为我们知道拿到令牌后，我们可以解码看到载荷部分的信息</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">JWT令牌每次请求都会携带，内容过多，会增加⽹络带宽占⽤</section></li></ul>
<blockquote data-tool="mdnice编辑器" style="display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px; border-left-color: rgb(239, 112, 96); background: #fff9f9;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">lagouedu 应颠大佬 笔记整理</p>
</blockquote>
<p id="nice-suffix-juejin-container" class="nice-suffix-juejin-container" data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; margin-top: 20px !important;">本文使用 <a href="https://mdnice.com/?from=juejin" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: rgb(239, 112, 96); border-bottom: 1px solid rgb(239, 112, 96);" target="_blank" rel="noopener">mdnice</a> 排版</p></section>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Spring-Cloud/">Spring Cloud</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/07/30/微服务监控之分布式链路追踪技术-Sleuth-Zipkin/">
                        <span class="hidden-mobile">微服务监控之分布式链路追踪技术 Sleuth + Zipkin</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">京ICP证123456号</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>京公网安备12345678号</span>
      </a>
     
  </div>


    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "微服务统⼀认证⽅案 Spring Cloud OAuth2 + JWT&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
